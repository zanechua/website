{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/setup-gitlab-runners-in-kubernetes-k3s-part-1/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://zanechua.com"}},"posts":{"html":"<p>This has been on my todo list for a while now for <a href=\"https://kopirun.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">KopiRun</a>. I had been using Azure VMs as GitLab runners, but we were trying to keep them under a certain cost, and unfortunately it was not feasible for us to keep the runners on Azure at the kind of performance we were getting. While I on the other hand had spare capacity within 3 sites and decided to run k3s on my ESXi nodes. The 3 sites are on their individual power grid + internet connection so in some sense there's already High Availability in separate availability zones involved (Not that I put any work into it) ðŸ˜‚.</p>\n<h1 id=\"Journey\" style=\"position:relative;\">Journey<a href=\"#Journey\" aria-label=\"Journey permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>I had done a bit of kubernetes before when I was trying out some QwikLabs last year and even provisioning an AKS (Azure Kubernetes Service) resource in Azure just to check it out. Other than that, my experience with kubernetes has pretty much been zilch.</p>\n<p>When I first started with provisioning a K3S cluster, I followed the tutorials in k3s docs on setting up the main node and then the worker nodes. I applied the requisite GitLab manifests to be able to connect the node to GitLab, but I hit a snag. No matter what I did, GitLab was unable to talk to my cluster. I tried dabbling with it until I unfortunately had more pressing things to do and dropped it.</p>\n<p>I resumed another day and verified the manifest configuration in the namespaces of the cluster. Turns out in my first foray into kubernetes, I had deleted a configuration value from the k3s cluster. The other problem was the nginx reverse proxy that I had placed in front of it and GitLab was having none of it.</p>\n<p>I tore down the existing cluster, and it's nodes and started from scratch. Once I rechecked my configurations and manifests, I was able to add my cluster to GitLab. Then I installed the GitLab Runner helm chart into the cluster. I configured the yaml with the relevant values set and tagged my jobs with k3s. Was so excited to see the runners get auto initialized only to have them fail right after.</p>\n<p>The runners were complaining that they could not resolve any external domains. It took a bit of debugging and the problem was that the alpine image has a bug in how it resolves dns entries. The <code class=\"language-text\">ndots</code> value is defaulted to 5 in kubernetes clusters. This means that it'll resolve domains that have less than 5 dots in your local search domains. Only once those return nothing, it should do an absolute query. But alpine does not do the absolute query and therefore just fails.</p>\n<p>A <code class=\"language-text\">pre_clone_script</code> needed to be added to remove the search domains so that external domains would resolve correctly. This <a href=\"https://github.com/gliderlabs/docker-alpine/issues/255\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bug</a> has been known since 2017,and it's still not fixed.</p>\n<p>Once I got past that, the rest was pretty smooth sailing. Setting up the cache in azure for the runners. The pipeline runs for <a href=\"https://kopirun.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">KopiRun</a> are now at least 2 x faster. Can't complain about that.</p>\n<p>All in all, still much to learn about kubernetes but was pretty fun in solving a real world problem for the team.</p>\n<h1 id=\"Solve\" style=\"position:relative;\">Solve<a href=\"#Solve\" aria-label=\"Solve permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>There are different nodes that you need to run the commands on. I've labelled these snippets with <code class=\"language-text\">main</code> or <code class=\"language-text\">worker</code>.</p>\n<ul>\n<li><code class=\"language-text\">main</code> represents the control-plane node</li>\n<li><code class=\"language-text\">worker</code> represents the worker nodes</li>\n</ul>\n<h2 id=\"Node-Setup\" style=\"position:relative;\">Node Setup<a href=\"#Node-Setup\" aria-label=\"Node Setup permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>I installed an instance of Ubuntu Server on each of the 3 ESXi hosts.</p>\n<p>Node Configuration:</p>\n<ul>\n<li>CPU: 16 Core</li>\n<li>MEM: 16 GB</li>\n<li>HDD: 32 GB</li>\n<li>HDD: 128 GB</li>\n</ul>\n<p>Edit your <code class=\"language-text\">/etc/hosts</code> file with the hostnames + FQDN of the other nodes.</p>\n<ol>\n<li>Expand root disk to consume full size.</li>\n<li>Enable IP Forwarding</li>\n<li>Reboot</li>\n<li>List all block devices</li>\n<li>Login as root user</li>\n<li>Use disk /dev/sdb and prepare for partitioning</li>\n<li>Format /dev/sdb1 as ext4 with 8192 bytes per inode</li>\n<li>Make directory at /mnt/k3s-store</li>\n<li>Mount /dev/sdb1 to /mnt/k3s-store</li>\n<li>List block device information</li>\n<li>Edit /etc/fstab</li>\n</ol>\n<blockquote>\n<p>Before running the commands, please note that 128 GB disk may be on a different mount point than <code class=\"language-text\">/dev/sdb</code>. Please verify with <code class=\"language-text\">lsblk</code> that the device is mounted otherwise please modify the command as needed.</p>\n</blockquote>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">main/worker</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"62143597509904900000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`# Use all available disk space\nlvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv\nresize2fs /dev/mapper/ubuntu--vg-ubuntu--lv\n# Enable IP Forwarding\nsudo sed -i 's~#net.ipv4.ip_forward=1~net.ipv4.ip_forward=1~g' /etc/sysctl.conf\nsudo reboot\nlsblk\nsudo -i\nfdisk /dev/sdb # new -> primary -> _enter_ -> write\nmkfs -t ext4 -i 8192  /dev/sdb1\nmkdir -p /mnt/k3s-store\nmount /dev/sdb1 /mnt/k3s-store\nblkid\nnano /etc/fstab`, `62143597509904900000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># Use all available disk space</span>\nlvextend <span class=\"token parameter variable\">-l</span> +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv\nresize2fs /dev/mapper/ubuntu--vg-ubuntu--lv\n<span class=\"token comment\"># Enable IP Forwarding</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s~#net.ipv4.ip_forward=1~net.ipv4.ip_forward=1~g'</span> /etc/sysctl.conf\n<span class=\"token function\">sudo</span> <span class=\"token function\">reboot</span>\nlsblk\n<span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-i</span>\n<span class=\"token function\">fdisk</span> /dev/sdb <span class=\"token comment\"># new -> primary -> _enter_ -> write</span>\n<span class=\"token function\">mkfs</span> <span class=\"token parameter variable\">-t</span> ext4 <span class=\"token parameter variable\">-i</span> <span class=\"token number\">8192</span>  /dev/sdb1\n<span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /mnt/k3s-store\n<span class=\"token function\">mount</span> /dev/sdb1 /mnt/k3s-store\nblkid\n<span class=\"token function\">nano</span> /etc/fstab</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Copy the UUID from the <code class=\"language-text\">blkid</code> command for <code class=\"language-text\">/dev/sdb1</code></p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">/etc/fstab</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"69232760441935510000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`UUID=81cb55b0-c012-4308-9e58-d6b9460887ff /mnt/k3s-store ext4 defaults,discard 0 1`, `69232760441935510000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">UUID=81cb55b0-c012-4308-9e58-d6b9460887ff /mnt/k3s-store ext4 defaults,discard 0 1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Save the file with <code class=\"language-text\">Ctrl + O</code> then <em>Enter</em> followed by <code class=\"language-text\">Ctrl + X</code> to exit.</p>\n<h3 id=\"Setting-up-the-main-node\" style=\"position:relative;\">Setting up the main node<a href=\"#Setting-up-the-main-node\" aria-label=\"Setting up the main node permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>I chose to go with the Calico CNI (Container Network Interface) instead of the default Flannel CNI since Calico is more prevalent in kubernetes clusters.</p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">main</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"76827441646260810000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`# Install K3S Server without flannel which is the default CNI\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC=&quot;--flannel-backend=none --disable-network-policy --cluster-cidr=10.42.0.0/16 --data-dir=/mnt/k3s-store&quot; sh -\nwget https://docs.projectcalico.org/manifests/calico.yaml`, `76827441646260810000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># Install K3S Server without flannel which is the default CNI</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-sfL</span> https://get.k3s.io <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">INSTALL_K3S_EXEC</span><span class=\"token operator\">=</span><span class=\"token string\">\"--flannel-backend=none --disable-network-policy --cluster-cidr=10.42.0.0/16 --data-dir=/mnt/k3s-store\"</span> <span class=\"token function\">sh</span> -\n<span class=\"token function\">wget</span> https://docs.projectcalico.org/manifests/calico.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Add the following snippet to <code class=\"language-text\">calico.yaml</code> to the <code class=\"language-text\">calico</code> type above the <code class=\"language-text\">policy</code> key.</p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">main</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"16408531347500110000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`&quot;container_settings&quot;: {\n    &quot;allow_ip_forwarding&quot;: true\n},`, `16408531347500110000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">\"container_settings\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token key atrule\">\"allow_ip_forwarding\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Run the following to complete the setup for the main node of the cluster.</p>\n<p>Add your WAN IP to the FQDN's zone provider.</p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">main</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"21521373764046324000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`kubectl config view --raw > ~/.kube/config\nchmod 600 ~/.kube/config\nkubectl apply -f calico.yaml`, `21521373764046324000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">kubectl config view <span class=\"token parameter variable\">--raw</span> <span class=\"token operator\">></span> ~/.kube/config\n<span class=\"token function\">chmod</span> <span class=\"token number\">600</span> ~/.kube/config\nkubectl apply <span class=\"token parameter variable\">-f</span> calico.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<h3 id=\"Adding-worker-nodes\" style=\"position:relative;\">Adding worker nodes<a href=\"#Adding-worker-nodes\" aria-label=\"Adding worker nodes permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>To add more nodes to the cluster. Run the following command to get the server token to use in the command that you run on the worker nodes.</p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">main</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"12504282661804034000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`cat /mnt/k3s-store/server/node-token`, `12504282661804034000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">cat</span> /mnt/k3s-store/server/node-token</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">worker</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"93874536794356480000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`# K3S Nodes\ncurl -sfL https://get.k3s.io | K3S_URL=https://k3s.example.com:6443 K3S_TOKEN=TOKEN INSTALL_K3S_EXEC=&quot;--data-dir=/mnt/k3s-store&quot; sh -`, `93874536794356480000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token comment\"># K3S Nodes</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-sfL</span> https://get.k3s.io <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">K3S_URL</span><span class=\"token operator\">=</span>https://k3s.example.com:6443 <span class=\"token assign-left variable\">K3S_TOKEN</span><span class=\"token operator\">=</span>TOKEN <span class=\"token assign-left variable\">INSTALL_K3S_EXEC</span><span class=\"token operator\">=</span><span class=\"token string\">\"--data-dir=/mnt/k3s-store\"</span> <span class=\"token function\">sh</span> -</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Now that the cluster is set up, follow part 2 <a href=\"/blog/setup-gitlab-runners-in-kubernetes-k3s-part-2\">here</a> to complete the runner setup.</p>","excerpt":"This has been on my todo list for a while now for KopiRun. I had been using Azure VMs as GitLab runners, but we were trying to keep them under a certain cost, and unfortunately it was not feasible for us to keep the runners on Azure at the kind ofâ€¦","timeToRead":4,"frontmatter":{"date":"03 October, 2021","updatedAt":null,"slug":"setup-gitlab-runners-in-kubernetes-k3s-part-1","title":"Setting up GitLab Runners in Kubernetes (K3S) - Part 1","tags":["homelab","infrastructure","kubernetes","dev ops","gitlab","ci cd","esxi"],"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA1klEQVQY02MIdW7HhYKdOsNd2sNd2oKdO7EqYMAqGubSHu7aluRRE+jQHuTQleRaG0Kk5jCX9mCHFhfLvnVZztcnu96qVVwV6ujpODHCpZWA5jCXdj/b1oUdk7sKO+cV5fw/4PJ/Bev0jAQv2z7CmiNc2z0t2zdM7v2/XOtOrvb/U9Vvd6QkB3YFOYDMJWhzW4Bjd7Zf2dc2tv/JDP93Je2a1+1j2RLuSqSfndt8HXu3Zdv8Cmf41GBQndLuZ9se7kJ0aIc4d8a6Nea6lWS6lYc5teGKSwDB078BBO8GQgAAAABJRU5ErkJggg=="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/6144034945e35de431500a4fa7d29cba/6fc77/setup-gitlab-runners-in-kubernetes-k3s.png","srcSet":"/static/6144034945e35de431500a4fa7d29cba/85ced/setup-gitlab-runners-in-kubernetes-k3s.png 800w,\n/static/6144034945e35de431500a4fa7d29cba/7c498/setup-gitlab-runners-in-kubernetes-k3s.png 1080w,\n/static/6144034945e35de431500a4fa7d29cba/6fc77/setup-gitlab-runners-in-kubernetes-k3s.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/6144034945e35de431500a4fa7d29cba/28281/setup-gitlab-runners-in-kubernetes-k3s.webp 800w,\n/static/6144034945e35de431500a4fa7d29cba/0b5d5/setup-gitlab-runners-in-kubernetes-k3s.webp 1080w,\n/static/6144034945e35de431500a4fa7d29cba/a020d/setup-gitlab-runners-in-kubernetes-k3s.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":500}}}}},"comments":{"edges":[]}},"pageContext":{"slug":"setup-gitlab-runners-in-kubernetes-k3s-part-1"}},"staticQueryHashes":["3649515864","983108779"],"slicesMap":{}}