{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/improve-gitlab-pipelines-node/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://zanechua.com"}},"posts":{"html":"<p>Running test stages for <code class=\"language-text\">react-native</code> repos or NodeJS repos can be really painful if <code class=\"language-text\">yarn install</code> is taking too long to complete. Even though GitLab suggests you to use a cache configuration to cache the vendor folder so you won't have to wait for <code class=\"language-text\">yarn install</code> to complete everytime, there seems to be an <a href=\"https://gitlab.com/gitlab-org/gitlab-runner/-/issues/1797\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">issue</a> with how long the caching actually takes to complete.</p>\n<h1 id=\"Journey\" style=\"position:relative;\">Journey<a href=\"#Journey\" aria-label=\"Journey permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>I've hit into this issue in the <a href=\"https://kopirun.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">KopiRun</a> pipelines and I set out to solve this. We're a small team and we don't particularly add or update packages that often, most of the time I'm the only one doing so. We don't want our machines to always be uploading caches if the cache is still relevant.</p>\n<p>GitLab only has a pull-push, pull, push policy for the cache. They are missing a <code class=\"language-text\">push if outdated</code> as mentioned <a href=\"https://gitlab.com/gitlab-org/gitlab-runner/-/issues/3523\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n<p>Someone found out that if you remove the folders to be cached, the runners won't update the cache and therefore won't waste anytime to push the cache files. They provided a sample <code class=\"language-text\">.gitlab-ci.yml</code> configuration but that didn't really fit my needs so this led to me writing my own cache stage to not push if the cache is still relevant (Based off a hash of the <code class=\"language-text\">yarn.lock</code> file).</p>\n<h1 id=\"Solve\" style=\"position:relative;\">Solve<a href=\"#Solve\" aria-label=\"Solve permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>The following configuration has helped us save about 5 to 15 minutes depending on the project due to how it was previously configured.</p>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">gitlab-ci.yml</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"37226276997531800000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`stages:\n  - cache\n  - test\n\ncache_job:\n  stage: cache\n  tags:\n    - docker\n  cache:\n    key:\n      files:\n        - yarn.lock\n    paths:\n      - node_modules/\n      - .yarn/\n      - yarn.lock.sha256sum\n    policy: pull-push\n    when: on_failure\n  script:\n    - CI_JOB_SKIP_EXIT_CODE=0\n    - yarn install --frozen-lockfile --prefer-offline --cache-folder .yarn\n    -  # do whatever\n    - |\n      YARN_LOCK_SHA256_HASH=\\$( sha256sum yarn.lock | awk '{ print \\$1 }')\n      echo &quot;Current sha256 hash is \\$YARN_LOCK_SHA256_HASH&quot;\n      echo &quot;Checking sha256 hash of yarn.lock&quot;\n\n      if ! sha256sum -c yarn.lock.sha256sum; then\n        echo &quot;yarn.lock checksum does not match cache&quot;\n        sha256sum yarn.lock > yarn.lock.sha256sum\n        CI_JOB_SKIP_EXIT_CODE=218\n      else\n        echo &quot;Cache is the same as before, won't update cache&quot;\n      fi\n    - exit \\$CI_JOB_SKIP_EXIT_CODE\n  allow_failure:\n    exit_codes: 218\n\ntest_stage:\n  stage: test\n  tags:\n    - docker\n  cache:\n    - key:\n        files:\n          - yarn.lock\n      paths:\n        - node_modules/\n        - .yarn/\n      policy: pull\n  script:\n    - echo &quot;Test Stage&quot;`, `37226276997531800000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> cache\n  <span class=\"token punctuation\">-</span> test\n\n<span class=\"token key atrule\">cache_job</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> cache\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> docker\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> yarn.lock\n    <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> node_modules/\n      <span class=\"token punctuation\">-</span> .yarn/\n      <span class=\"token punctuation\">-</span> yarn.lock.sha256sum\n    <span class=\"token key atrule\">policy</span><span class=\"token punctuation\">:</span> pull<span class=\"token punctuation\">-</span>push\n    <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> on_failure\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> CI_JOB_SKIP_EXIT_CODE=0\n    <span class=\"token punctuation\">-</span> yarn install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>frozen<span class=\"token punctuation\">-</span>lockfile <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>prefer<span class=\"token punctuation\">-</span>offline <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>cache<span class=\"token punctuation\">-</span>folder .yarn\n    <span class=\"token punctuation\">-</span>  <span class=\"token comment\"># do whatever</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      YARN_LOCK_SHA256_HASH=$( sha256sum yarn.lock | awk '{ print $1 }')\n      echo \"Current sha256 hash is $YARN_LOCK_SHA256_HASH\"\n      echo \"Checking sha256 hash of yarn.lock\"</span>\n\n      if <span class=\"token tag\">!</span> sha256sum <span class=\"token punctuation\">-</span>c yarn.lock.sha256sum; then\n        echo \"yarn.lock checksum does not match cache\"\n        sha256sum yarn.lock <span class=\"token punctuation\">></span> yarn.lock.sha256sum\n        CI_JOB_SKIP_EXIT_CODE=218\n      else\n        echo \"Cache is the same as before<span class=\"token punctuation\">,</span> won't update cache\"\n      fi\n    <span class=\"token punctuation\">-</span> exit $CI_JOB_SKIP_EXIT_CODE\n  <span class=\"token key atrule\">allow_failure</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">exit_codes</span><span class=\"token punctuation\">:</span> <span class=\"token number\">218</span>\n\n<span class=\"token key atrule\">test_stage</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> test\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> docker\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> yarn.lock\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> node_modules/\n        <span class=\"token punctuation\">-</span> .yarn/\n      <span class=\"token key atrule\">policy</span><span class=\"token punctuation\">:</span> pull\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> echo \"Test Stage\"</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"Change-Log\" style=\"position:relative;\">Change Log<a href=\"#Change-Log\" aria-label=\"Change Log permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><code class=\"language-text\">2023-05-03</code> - Renamed the job to <code class=\"language-text\">cache_job</code></li>\n<li><code class=\"language-text\">2022-09-10</code> - Updated example to support both SaaS and Self-Managed instances</li>\n</ul>","excerpt":"Running test stages for  repos or NodeJS repos can be really painful if  is taking too long to complete. Even though GitLab suggests you to use a cache configuration to cache the vendor folder so you won't have to wait for  to complete everytime…","timeToRead":2,"frontmatter":{"date":"02 August, 2021","updatedAt":["2023-05-03"],"slug":"improve-gitlab-pipelines-node","title":"Improving GitLab Pipeline Speeds for NodeJS","tags":["gitlab","node","dev ops","ci cd"],"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA1klEQVR42mO4XSaAie6UCdwv43tUwvmonPthBef9Cp5bZYKYyhgwhe6WCVwoFtpXKLu60npDru7GdLMD2SoPsOlH13yrTOBhhcCubL6uWLGqbJe6KIP2YOvt6ZoPK7lvlRLSfLNU8HEV9+oE40LP3Cp/z+LApFy/9LXJ2o8reW4SoVnoaRXXghjzLK/qmpiUnPCGpOBJ8+KsnlZxAqUI+xnk+HKBR0UsHUXeXcVujwuxq8Gp+XaZ4MNSrk0V+hsr9B+Wcd/GFtR4NANDThCoDYhu4dAJRAAOz9hVrJrWQwAAAABJRU5ErkJggg=="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/a4dedbcd49cf5b68054090b581569e48/6fc77/improve-gitlab-pipelines-node.png","srcSet":"/static/a4dedbcd49cf5b68054090b581569e48/85ced/improve-gitlab-pipelines-node.png 800w,\n/static/a4dedbcd49cf5b68054090b581569e48/7c498/improve-gitlab-pipelines-node.png 1080w,\n/static/a4dedbcd49cf5b68054090b581569e48/6fc77/improve-gitlab-pipelines-node.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/a4dedbcd49cf5b68054090b581569e48/28281/improve-gitlab-pipelines-node.webp 800w,\n/static/a4dedbcd49cf5b68054090b581569e48/0b5d5/improve-gitlab-pipelines-node.webp 1080w,\n/static/a4dedbcd49cf5b68054090b581569e48/a020d/improve-gitlab-pipelines-node.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":500}}}}},"comments":{"edges":[]}},"pageContext":{"slug":"improve-gitlab-pipelines-node"}},"staticQueryHashes":["3649515864","983108779"],"slicesMap":{}}