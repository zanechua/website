{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/speed-up-kaniko-builds/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://zanechua.com"}},"posts":{"html":"<p>Kaniko is a pretty popular tool for building container images today as it does not require any kind of privilege or root permission to build containers unlike Docker-in-Docker. Having the ability to build container images without privilege while reducing the container build time is especially important when you have subsequent pipeline stages that require the usage of the container. e.g. Running the container as a service and running integration tests on it.</p>\n<p>The problem with Kaniko today is that the build times are really slow due to the way it works and optimizing the arguments does not seem to always help.</p>\n<h1 id=\"Journey\" style=\"position:relative;\">Journey<a href=\"#Journey\" aria-label=\"Journey permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Optimizing Kaniko build duration has been a tricky problem that I have been trying to solve. This is my fifth attempt at trying to improve the container build duration and I have finally seen significant improvements in the build duration as well as it being very consistently fast.</p>\n<p>This time I stumbled upon this <a href=\"https://github.com/GoogleContainerTools/kaniko/issues/2021\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">issue</a> in the Kaniko repository. Basically the crux of the issue is that Kaniko mounts the <code class=\"language-text\">--context</code> argument as a volume in the <code class=\"language-text\">Dockerfile</code> when you're building the container and the <code class=\"language-text\">WORKDIR</code> is set to the same directory. This does not happen in typical Docker-in-Docker builds however this got me thinking if we can take advantage of this behvaiour.</p>\n<p>I have written before about how you can <a href=\"/blog/improve-gitlab-pipelines-node\">Improving GitLab Pipeline Speeds for NodeJS</a> by using a <code class=\"language-text\">cache_job</code>. If you combine this with <a href=\"/blog/lint-and-format-code-node-gitlab-pipelines\">Lint and Format Code in NodeJS with GitLab Pipelines</a>, you essentially only need one job to run at the start of every CI run that basically bootstraps the cache and project for you.</p>\n<p>Once that cache has been bootstrapped, you set the Kaniko <code class=\"language-text\">--context</code> argument and the <code class=\"language-text\">WORKDIR</code> in the <code class=\"language-text\">Dockerfile</code> as the same directory. This way the CI will pass the cached libraries into the container build which allows you to use the cached libraries instead of having to spend time reinstalling the libraries again. There are a few caveats though.</p>\n<ol>\n<li>You must use the same architecture for your cache as well as your Dockerfile. E.g. You cannot use an <code class=\"language-text\">aarch64</code> cache and then try to build the container for <code class=\"language-text\">x86_64</code>. The cache will be invalid due to the differences in architecture.</li>\n<li>You must have fast IO for your cache restore, otherwise its pointless as it will even be slower without cache</li>\n</ol>\n<p>This improvement is not limited to any particular language or DevSecOps Platform and can be used for any other language or platform as long as you have a way to utilize a caching strategy that contains your library dependencies.</p>\n<p>I am unsure if the linked issue above is an actual bug with Kaniko and will be fixed in a future version, or it is working as intended. Either way, we can take advantage of the way Kaniko works today to improve the build times.</p>\n<p>I have seen improvements of around 300%, the build time for the container was around 6-minutes before utilizing the cache. After leveraging this technique, it basically dropped to a 2-minute build.</p>\n<p>The Kaniko build cache is also utilized more than it was previously.</p>\n<h1 id=\"Solve\" style=\"position:relative;\">Solve<a href=\"#Solve\" aria-label=\"Solve permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>I will be providing an example using GitLab as that is what I am most familiar with but this should work the same for any other DevSecOps platform.</p>\n<p>I am utilizing the same <code class=\"language-text\">cache_job</code> job from the post about <a href=\"/blog/improve-gitlab-pipelines-node\">Improving GitLab Pipeline Speeds for NodeJS</a>, we will be using it as a dependency for the <code class=\"language-text\">container_build_job</code>. The job is very similar to the example that is provided in the GitLab docs with a few notable changes:</p>\n<ul>\n<li>No <code class=\"language-text\">--cache-copy-layers</code> argument is present as I use multi-stage container builds</li>\n<li>Added cache key to pull the library caches</li>\n<li>Bash replacement to replace slashes with dashes due to Kaniko not accepting slashes</li>\n<li>Additional build arguments that are passed through to the <code class=\"language-text\">Dockerfile</code></li>\n</ul>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">gitlab-ci.yml</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"83986320128037630000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`container_build_job:\n  stage: build\n  image:\n    name: gcr.io/kaniko-project/executor:v1.9.2-debug\n    entrypoint: [&quot;&quot;]\n  cache:\n    - key:\n        files:\n          - yarn.lock\n      paths:\n        - node_modules/\n        - .yarn/\n      policy: pull\n  variables:\n    IMAGE_LABELS: >\n      --label vcs-url=\\$CI_PROJECT_URL\n      --label com.gitlab.ci.email=\\$GITLAB_USER_EMAIL\n      --label com.gitlab.ci.tagorbranch=\\$CI_COMMIT_REF_NAME\n      --label com.gitlab.ci.pipelineurl=\\$CI_PIPELINE_URL\n      --label com.gitlab.ci.commiturl=\\$CI_PROJECT_URL/commit/\\$CI_COMMIT_SHA\n      --label com.gitlab.ci.cijoburl=\\$CI_JOB_URL\n      --label com.gitlab.ci.mrurl=\\$CI_PROJECT_URL/-/merge_requests/\\$CI_MERGE_REQUEST_ID\n  script:\n    - echo &quot;Container Build Job&quot;\n    - |\n      echo &quot;Building and shipping image to \\$CI_REGISTRY_IMAGE&quot;\n      if [[ &quot;\\$CI_COMMIT_BRANCH&quot; == &quot;master&quot; ]]; then\n        ADD_LATEST_TAG=&quot;--destination \\$CI_REGISTRY_IMAGE:latest&quot;;\n      fi\n    - |\n      if [[ -n &quot;\\$ADDITIONAL_TAG_LIST&quot; ]]; then\n        for TAG in \\$ADDITIONAL_TAG_LIST; do\n          FORMATTED_TAG_LIST=&quot;\\${FORMATTED_TAG_LIST} --destination \\$CI_REGISTRY_IMAGE:\\$TAG &quot;;\n        done;\n      fi\n    - |\n      echo &quot;{\\&quot;auths\\&quot;:{\\&quot;\\$CI_REGISTRY\\&quot;:{\\&quot;auth\\&quot;:\\&quot;\\$(echo -n \\$CI_REGISTRY_USER:\\$CI_REGISTRY_PASSWORD | base64)\\&quot;}}}&quot; > /kaniko/.docker/config.json\n      echo /kaniko/executor --cache=true --snapshot-mode=redo --use-new-run --context \\$CI_PROJECT_DIR --dockerfile \\$CI_PROJECT_DIR/Dockerfile --destination \\$CI_REGISTRY_IMAGE:\\${CI_COMMIT_REF_NAME//\\//-} --destination \\$CI_REGISTRY_IMAGE:\\$CI_COMMIT_SHORT_SHA \\$ADD_LATEST_TAG \\$ADD_VERSION_TAG \\$FORMATTED_TAG_LIST \\$IMAGE_LABELS --label build-date=\\`date -Iseconds\\` --build-arg CI_PROJECT_DIR=\\$CI_PROJECT_DIR --build-arg CI_COMMIT_SHORT_SHA=\\$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_TAG=\\$CI_COMMIT_TAG --build-arg CI_COMMIT_TIMESTAMP=\\$CI_COMMIT_TIMESTAMP\n      if [[ &quot;\\$CI_COMMIT_TAG&quot; == &quot;&quot; ]]; then CI_COMMIT_TAG=&quot;untagged&quot;; fi\n      /kaniko/executor \\\n        --cache=true \\\n        --use-new-run \\\n        --snapshot-mode=redo \\\n        --context \\$CI_PROJECT_DIR \\\n        --dockerfile \\$CI_PROJECT_DIR/Dockerfile \\\n        --destination \\$CI_REGISTRY_IMAGE:\\${CI_COMMIT_REF_NAME//\\//-} \\\n        --destination \\$CI_REGISTRY_IMAGE:\\$CI_COMMIT_SHA \\\n        --destination \\$CI_REGISTRY_IMAGE:\\$CI_COMMIT_SHORT_SHA \\$ADD_LATEST_TAG \\$ADD_VERSION_TAG \\$FORMATTED_TAG_LIST \\$IMAGE_LABELS \\\n        --label build-date=\\`date -Iseconds\\` \\\n        --build-arg CI_PROJECT_DIR=\\$CI_PROJECT_DIR \\\n        --build-arg CI_COMMIT_SHORT_SHA=\\$CI_COMMIT_SHORT_SHA \\\n        --build-arg CI_COMMIT_TAG=\\$CI_COMMIT_TAG \\\n        --build-arg CI_COMMIT_TIMESTAMP=\\$CI_COMMIT_TIMESTAMP\n  retry: 2\n  needs:\n    - job: cache_job\n      artifacts: true`, `83986320128037630000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">container_build_job</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> build\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gcr.io/kaniko<span class=\"token punctuation\">-</span>project/executor<span class=\"token punctuation\">:</span>v1.9.2<span class=\"token punctuation\">-</span>debug\n    <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">files</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> yarn.lock\n      <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> node_modules/\n        <span class=\"token punctuation\">-</span> .yarn/\n      <span class=\"token key atrule\">policy</span><span class=\"token punctuation\">:</span> pull\n  <span class=\"token key atrule\">variables</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">IMAGE_LABELS</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token scalar string\">\n      --label vcs-url=$CI_PROJECT_URL\n      --label com.gitlab.ci.email=$GITLAB_USER_EMAIL\n      --label com.gitlab.ci.tagorbranch=$CI_COMMIT_REF_NAME\n      --label com.gitlab.ci.pipelineurl=$CI_PIPELINE_URL\n      --label com.gitlab.ci.commiturl=$CI_PROJECT_URL/commit/$CI_COMMIT_SHA\n      --label com.gitlab.ci.cijoburl=$CI_JOB_URL\n      --label com.gitlab.ci.mrurl=$CI_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_ID</span>\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> echo \"Container Build Job\"\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      echo \"Building and shipping image to $CI_REGISTRY_IMAGE\"\n      if [[ \"$CI_COMMIT_BRANCH\" == \"master\" ]]; then\n        ADD_LATEST_TAG=\"--destination $CI_REGISTRY_IMAGE:latest\";\n      fi</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      if [[ -n \"$ADDITIONAL_TAG_LIST\" ]]; then\n        for TAG in $ADDITIONAL_TAG_LIST; do\n          FORMATTED_TAG_LIST=\"${FORMATTED_TAG_LIST} --destination $CI_REGISTRY_IMAGE:$TAG \";\n        done;\n      fi</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      echo \"{\\\"auths\\\":{\\\"$CI_REGISTRY\\\":{\\\"auth\\\":\\\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\\\"}}}\" > /kaniko/.docker/config.json\n      echo /kaniko/executor --cache=true --snapshot-mode=redo --use-new-run --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:${CI_COMMIT_REF_NAME//\\//-} --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $ADD_LATEST_TAG $ADD_VERSION_TAG $FORMATTED_TAG_LIST $IMAGE_LABELS --label build-date=`date -Iseconds` --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR --build-arg CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_TAG=$CI_COMMIT_TAG --build-arg CI_COMMIT_TIMESTAMP=$CI_COMMIT_TIMESTAMP\n      if [[ \"$CI_COMMIT_TAG\" == \"\" ]]; then CI_COMMIT_TAG=\"untagged\"; fi\n      /kaniko/executor \\\n        --cache=true \\\n        --use-new-run \\\n        --snapshot-mode=redo \\\n        --context $CI_PROJECT_DIR \\\n        --dockerfile $CI_PROJECT_DIR/Dockerfile \\\n        --destination $CI_REGISTRY_IMAGE:${CI_COMMIT_REF_NAME//\\//-} \\\n        --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \\\n        --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $ADD_LATEST_TAG $ADD_VERSION_TAG $FORMATTED_TAG_LIST $IMAGE_LABELS \\\n        --label build-date=`date -Iseconds` \\\n        --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR \\\n        --build-arg CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA \\\n        --build-arg CI_COMMIT_TAG=$CI_COMMIT_TAG \\\n        --build-arg CI_COMMIT_TIMESTAMP=$CI_COMMIT_TIMESTAMP</span>\n  <span class=\"token key atrule\">retry</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job</span><span class=\"token punctuation\">:</span> cache_job\n      <span class=\"token key atrule\">artifacts</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Here's my multi-stage <code class=\"language-text\">Dockerfile</code> which has 3 stages</p>\n<ol>\n<li><code class=\"language-text\">dependencies</code> stage</li>\n<li><code class=\"language-text\">builder</code> stage</li>\n<li><code class=\"language-text\">production</code> stage</li>\n</ol>\n<p>The <code class=\"language-text\">dependencies</code> stage basically just utilizes the cached library dependencies and tries to install the dependencies. In the event that no cache is present, the stage will succeed but if cache is present, it will complete in a few seconds.</p>\n<p>The <code class=\"language-text\">builder</code> stage basically sets-up your code and runs your build commands, e.g. babel or simply copying over the javascript files that are meant to be in the production container. It first starts out with the development library dependencies, but we run a <code class=\"language-text\">yarn install</code> with the <code class=\"language-text\">--production</code> flag so that we only get the necessary modules in production, reducing the bloat on the final container image.</p>\n<p>The last stage, the unnamed stage essentially but let's call it the <code class=\"language-text\">production</code> stage as it will be the stage that determine what files make it into the final container image. In this stage, we are setting up some default arguments like <code class=\"language-text\">UID</code> and <code class=\"language-text\">GID</code> that represent <code class=\"language-text\">User ID</code> and <code class=\"language-text\">Group ID</code> respectively. We are also setting the default <code class=\"language-text\">user</code> and <code class=\"language-text\">group </code>. We add the <code class=\"language-text\">shadow</code> and <code class=\"language-text\">sudo</code> packages to bootstrap the <code class=\"language-text\">user</code> and the <code class=\"language-text\">group</code> based on the <code class=\"language-text\">UID</code> and <code class=\"language-text\">GID</code>. Once that is done, we copy over the entrypoint, the built files, as well as the production dependencies, and change the owner of the copied files to <code class=\"language-text\">user</code> and <code class=\"language-text\">group</code>. We run <code class=\"language-text\">yarn install</code> again to make sure that the integrity of the <code class=\"language-text\">node_modules</code> we copied over is validated and should finish in a few seconds. We finish by setting up the health check, entrypoint and command for the container.</p>\n<blockquote>\n<p>This is a rootless container, and therefore you will be unable to use privileged ports e.g. 80 or 443. That's why this container is using 8080</p>\n</blockquote>\n<div class=\"gatsby-code-title gatsby-remark-code-title\">Dockerfile</div>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"87950697676696620000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`# Install dependencies only when needed\nFROM node:18.16.0-alpine as dependencies\n# Use the CI_PROJECT_DIR as the WORKDIR as it is the context argument for kaniko and is mounted by default\n# Unsure if bug or intended behaviour: https://github.com/GoogleContainerTools/kaniko/issues/2021\nARG CI_PROJECT_DIR\n# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.\n#RUN apk add --no-cache libc6-compat\n# Take advantage of the context of kaniko being mounted and therefore being able to use the cached build dependencies from GitLab\n# The only caveat is the cached build dependencies have to be for the same architecture, otherwise it will likely not work\nWORKDIR \\$CI_PROJECT_DIR\nRUN yarn install --frozen-lockfile --prefer-offline --cache-folder .yarn\n\nFROM node:18.16.0-alpine as builder\nARG CI_PROJECT_DIR\nWORKDIR /builder\n# Use node_modules and .yarn cache\nCOPY --from=dependencies \\$CI_PROJECT_DIR/node_modules ./node_modules\nCOPY --from=dependencies \\$CI_PROJECT_DIR/.yarn ./.yarn\n# Copy relevant files/sources so we can run a build\n# Install package versions based on lock file\nRUN yarn install --frozen-lockfile --prefer-offline --cache-folder .yarn\n# Build code\nRUN yarn build\n# Use production library dependencies\nRUN yarn install --frozen-lockfile --production --prefer-offline --cache-folder .yarn\n\nFROM node:18.16.0-alpine\nARG UID=12345\nARG GID=23456\nENV UID=\\${UID}\nENV GID=\\${GID}\nENV USER=docker\nENV GROUP=docker\nENV WORKDIR=/srv/http/www/backend\nUSER root\n#https://github.com/mhart/alpine-node/issues/48#issuecomment-430902787\nRUN apk add --no-cache shadow sudo && \\\n    if [ -z &quot;\\`getent group \\$GID\\`&quot; ]; then \\\n      addgroup -S -g \\$GID \\$GROUP; \\\n    else \\\n      groupmod -n \\$GROUP \\`getent group \\$GID | cut -d: -f1\\`; \\\n    fi && \\\n    if [ -z &quot;\\`getent passwd \\$UID\\`&quot; ]; then \\\n      adduser -S -u \\$UID -G \\$GROUP -s /bin/sh \\$USER; \\\n    else \\\n      usermod -l \\$USER -g \\$GID -d /home/\\$USER -m \\`getent passwd \\$UID | cut -d: -f1\\`; \\\n    fi\nCOPY --from=builder /builder/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh\nRUN chmod +x /usr/local/bin/docker-entrypoint.sh\nWORKDIR \\$WORKDIR\nRUN chown -R \\$USER:\\$GROUP \\$WORKDIR\n# Tell docker that all future commands should run as the docker user\nUSER \\$USER\nCOPY --chown=\\$USER:\\$GROUP --from=builder /builder/node_modules ./node_modules\nCOPY --chown=\\$USER:\\$GROUP --from=builder /builder/build .\nRUN yarn install --frozen-lockfile --production --prefer-offline\nHEALTHCHECK CMD wget --no-verbose --tries=1 --spider http://localhost:8080/probe || exit 1\nEXPOSE 8080\nENTRYPOINT [&quot;docker-entrypoint.sh&quot;]\nCMD [&quot;yarn&quot;, &quot;start:server&quot;]`, `87950697676696620000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-docker line-numbers\"><code class=\"language-docker\"><span class=\"token comment\"># Install dependencies only when needed</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18.16.0-alpine <span class=\"token keyword\">as</span> dependencies</span>\n<span class=\"token comment\"># Use the CI_PROJECT_DIR as the WORKDIR as it is the context argument for kaniko and is mounted by default</span>\n<span class=\"token comment\"># Unsure if bug or intended behaviour: https://github.com/GoogleContainerTools/kaniko/issues/2021</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> CI_PROJECT_DIR</span>\n<span class=\"token comment\"># Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.</span>\n<span class=\"token comment\">#RUN apk add --no-cache libc6-compat</span>\n<span class=\"token comment\"># Take advantage of the context of kaniko being mounted and therefore being able to use the cached build dependencies from GitLab</span>\n<span class=\"token comment\"># The only caveat is the cached build dependencies have to be for the same architecture, otherwise it will likely not work</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> <span class=\"token variable\">$CI_PROJECT_DIR</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn install --frozen-lockfile --prefer-offline --cache-folder .yarn</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18.16.0-alpine <span class=\"token keyword\">as</span> builder</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> CI_PROJECT_DIR</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /builder</span>\n<span class=\"token comment\"># Use node_modules and .yarn cache</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">dependencies</span></span> <span class=\"token variable\">$CI_PROJECT_DIR</span>/node_modules ./node_modules</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">dependencies</span></span> <span class=\"token variable\">$CI_PROJECT_DIR</span>/.yarn ./.yarn</span>\n<span class=\"token comment\"># Copy relevant files/sources so we can run a build</span>\n<span class=\"token comment\"># Install package versions based on lock file</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn install --frozen-lockfile --prefer-offline --cache-folder .yarn</span>\n<span class=\"token comment\"># Build code</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn build</span>\n<span class=\"token comment\"># Use production library dependencies</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn install --frozen-lockfile --production --prefer-offline --cache-folder .yarn</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18.16.0-alpine</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> UID=12345</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> GID=23456</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> UID=<span class=\"token variable\">${UID}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> GID=<span class=\"token variable\">${GID}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> USER=docker</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> GROUP=docker</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> WORKDIR=/srv/http/www/backend</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> root</span>\n<span class=\"token comment\">#https://github.com/mhart/alpine-node/issues/48#issuecomment-430902787</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk add --no-cache shadow sudo &amp;&amp; <span class=\"token operator\">\\</span>\n    if [ -z <span class=\"token string\">\"`getent group $GID`\"</span> ]; then <span class=\"token operator\">\\</span>\n      addgroup -S -g <span class=\"token variable\">$GID</span> <span class=\"token variable\">$GROUP</span>; <span class=\"token operator\">\\</span>\n    else <span class=\"token operator\">\\</span>\n      groupmod -n <span class=\"token variable\">$GROUP</span> `getent group <span class=\"token variable\">$GID</span> | cut -d: -f1`; <span class=\"token operator\">\\</span>\n    fi &amp;&amp; <span class=\"token operator\">\\</span>\n    if [ -z <span class=\"token string\">\"`getent passwd $UID`\"</span> ]; then <span class=\"token operator\">\\</span>\n      adduser -S -u <span class=\"token variable\">$UID</span> -G <span class=\"token variable\">$GROUP</span> -s /bin/sh <span class=\"token variable\">$USER</span>; <span class=\"token operator\">\\</span>\n    else <span class=\"token operator\">\\</span>\n      usermod -l <span class=\"token variable\">$USER</span> -g <span class=\"token variable\">$GID</span> -d /home/<span class=\"token variable\">$USER</span> -m `getent passwd <span class=\"token variable\">$UID</span> | cut -d: -f1`; <span class=\"token operator\">\\</span>\n    fi</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /builder/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> <span class=\"token variable\">$WORKDIR</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chown -R <span class=\"token variable\">$USER</span>:<span class=\"token variable\">$GROUP</span> <span class=\"token variable\">$WORKDIR</span></span>\n<span class=\"token comment\"># Tell docker that all future commands should run as the docker user</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> <span class=\"token variable\">$USER</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">$USER:$GROUP</span> <span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /builder/node_modules ./node_modules</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--chown</span><span class=\"token punctuation\">=</span><span class=\"token string\">$USER:$GROUP</span> <span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /builder/build .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yarn install --frozen-lockfile --production --prefer-offline</span>\n<span class=\"token instruction\"><span class=\"token keyword\">HEALTHCHECK</span> <span class=\"token keyword\">CMD</span> wget --no-verbose --tries=1 --spider http://localhost:8080/probe || exit 1</span>\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 8080</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"docker-entrypoint.sh\"</span>]</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"yarn\"</span>, <span class=\"token string\">\"start:server\"</span>]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>So in summary, you are now able to get faster builds by leveraging the pipeline cache and the volume mounting behaviour of Kaniko today.</p>\n<p>Hope that helped you, please feel free to leave a comment to let me know if this worked or did not work for you.</p>\n<blockquote>\n<p>Disclaimer: This post was written when I was employed at GitLab. The content written above was done in my individual capacity.</p>\n</blockquote>","excerpt":"Kaniko is a pretty popular tool for building container images today as it does not require any kind of privilege or root permission to build containers unlike Docker-in-Docker. Having the ability to build container images without privilege whileâ€¦","timeToRead":7,"frontmatter":{"date":"03 May, 2023","updatedAt":null,"slug":"speed-up-kaniko-builds","title":"Speed up Kaniko builds","tags":["gitlab","node","dev ops","ci cd","automation","javascript","container"],"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA0UlEQVR42mP4n5qKBaWlgVB6+v+UZBA3IxOrMgasOj8nJNyKiHwfHn47M29DbNwFH9f/aemENf8Dkulp9yKjtjvZHq9pOrZ/yoI5oRsTk/8nJf0DuoUIm1O/JyStcXLcu3bdvWt7Du6edjO7AOj+f0TYnPI/LeNJTPiOSuvZ0c7bV685UdP4Nz7uP4a1WDT/BWnO3BXqfnev544CuzVOTjudbB9ERQE1/yMqwFJSb8aH7A1zfx4T9TEeGHIRXxMTibIZhoBRlQmKqrRUMJmGVRkAUyoXoiDUoCYAAAAASUVORK5CYII="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/bc2e6d6758fc1522fabb6feab7072234/6fc77/speed-up-kaniko-builds.png","srcSet":"/static/bc2e6d6758fc1522fabb6feab7072234/85ced/speed-up-kaniko-builds.png 800w,\n/static/bc2e6d6758fc1522fabb6feab7072234/7c498/speed-up-kaniko-builds.png 1080w,\n/static/bc2e6d6758fc1522fabb6feab7072234/6fc77/speed-up-kaniko-builds.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/bc2e6d6758fc1522fabb6feab7072234/28281/speed-up-kaniko-builds.webp 800w,\n/static/bc2e6d6758fc1522fabb6feab7072234/0b5d5/speed-up-kaniko-builds.webp 1080w,\n/static/bc2e6d6758fc1522fabb6feab7072234/a020d/speed-up-kaniko-builds.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":500}}}}},"comments":{"edges":[{"node":{"id":"9cb5c23f-d13a-539c-90a9-6193811f921b","slug":"speed-up-kaniko-builds","name":"Derek","date":"22 May, 2024 at 4:05 PM","message":"This is interesting. Is there a reason that you do the build process inside of your dockerfile rather than in the CI environment? I run a separate job first that runs the yarn build and some other dependency building concurrently, then when that is all done, I run the Kaniko job and my dockerfile basically just copies in those artifacts."}},{"node":{"id":"2c7554ea-ac50-5426-aad1-16c8bd2161a5","slug":"speed-up-kaniko-builds","name":"Zane","date":"03 June, 2024 at 9:06 AM","message":"@Derek\n\nI haven't touched Kaniko in awhile but I believe it was due to some issues with the `COPY` command which Kaniko has some edge case issues processing and based on my memory, it doesn't end up using the cache with the `COPY` command so you end up with longer build times. \n\nIn your testing, do you see improvements with just doing the build outside and using the `COPY` command?"}}]}},"pageContext":{"slug":"speed-up-kaniko-builds"}},"staticQueryHashes":["3649515864","983108779"],"slicesMap":{}}