{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/stack-traces-sentry-apollo-graphql/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://zanechua.com"}},"posts":{"html":"<p>This is not a new problem that I faced but rather it's one that I solved quite awhile back. I haven't see any articles on the topic and I'm here assuming that everyone can get it working properly?</p>\n<p>But when I tried to get stack traces to function properly with Sentry and ApolloServer, they just did not want to work together properly in production. So here's what I did to get it working.</p>\n<h1 id=\"Solve\" style=\"position:relative;\">Solve<a href=\"#Solve\" aria-label=\"Solve permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>We are creating a new object based off the original object and appending the stack trace at the root level because Sentry expects the stack trace to be available at the root of the error object.\nApollo went ahead and decided on their own custom format instead of following the traditional conventions so we're forced to do this.</p>\n<p>We can use the <code class=\"language-text\">Object.create</code> method as it creates a new object for us to modify and also copies the prototype of the original object to the new object. Sentry's <code class=\"language-text\">captureException</code> method expects an <code class=\"language-text\">Error</code> prototype to be provided to it so this solves both of the requirements.</p>\n<p>You will also have to turn debug on for stack traces to appear in the error object for <code class=\"language-text\">ApolloServer</code>, you can easily strip the stacktrace before returning the object or just return a <code class=\"language-text\">string</code> in place.</p>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"63778321590800390000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`const server = new ApolloServer({\n  schema,\n  formatError: (error) => {\n    app.log.error(error);\n    const errorType = error.constructor.name;\n\n    const apolloErrorObject = Object.create(error);\n    apolloErrorObject.stack = error.extensions.exception.stacktrace.join('\\n');\n    Sentry.captureException(apolloErrorObject);\n\n    return stripStacktrace(error);\n  },\n  debug: true,\n  ...\n});\n\nconst stripStacktrace = (error) => {\n  delete error.extensions.exception;\n  return error;\n};`, `63778321590800390000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  schema<span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">formatError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    app<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> errorType <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> apolloErrorObject <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    apolloErrorObject<span class=\"token punctuation\">.</span>stack <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token punctuation\">.</span>exception<span class=\"token punctuation\">.</span>stacktrace<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Sentry<span class=\"token punctuation\">.</span><span class=\"token function\">captureException</span><span class=\"token punctuation\">(</span>apolloErrorObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token function\">stripStacktrace</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">debug</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">stripStacktrace</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> error<span class=\"token punctuation\">.</span>extensions<span class=\"token punctuation\">.</span>exception<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> error<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","excerpt":"This is not a new problem that I faced but rather it's one that I solved quite awhile back. I haven't see any articles on the topic and I'm here assuming that everyone can get it working properly? But when I tried to get stack traces to functionâ€¦","timeToRead":1,"frontmatter":{"date":"23 August, 2021","updatedAt":null,"slug":"stack-traces-sentry-apollo-graphql","title":"Stacktraces in Sentry for GraphQL on ApolloServer","tags":["node","javascript","dev ops","monitoring","sentry"],"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA5klEQVQY02N4FumAhl5E2V8Odj/iH3bUP/iof/CRgLArwe4vouwxVTKg8Z9GOr2JtKi3jbYx7HcwKHY1rrE3nl5nE/km0vJppBNBzY6vw21rXO2NrRwszSz8vQM1DUyLrE3eRNo/JcJmx9fhNjVuztpmzuamdp5uwUq6liV2lm8i7Z5GOhLU7PAq0q7R3mKyu3Onk22/q0O7lVWzjekrkGYHIjRHOR72tdzpbjvf2miBldEWW/PDXhavoh0Ja34W6fAcTF4KtL4ebHst2PZykPXTCPvnGMqwa4agl1GOL8DoZZQjLjUAQFfeP5SNFKQAAAAASUVORK5CYII="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/21999c995416b9fc5fa1ae874990929c/6fc77/stack-traces-sentry-apollo-graphql.png","srcSet":"/static/21999c995416b9fc5fa1ae874990929c/85ced/stack-traces-sentry-apollo-graphql.png 800w,\n/static/21999c995416b9fc5fa1ae874990929c/7c498/stack-traces-sentry-apollo-graphql.png 1080w,\n/static/21999c995416b9fc5fa1ae874990929c/6fc77/stack-traces-sentry-apollo-graphql.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/21999c995416b9fc5fa1ae874990929c/28281/stack-traces-sentry-apollo-graphql.webp 800w,\n/static/21999c995416b9fc5fa1ae874990929c/0b5d5/stack-traces-sentry-apollo-graphql.webp 1080w,\n/static/21999c995416b9fc5fa1ae874990929c/a020d/stack-traces-sentry-apollo-graphql.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":500}}}}},"comments":{"edges":[]}},"pageContext":{"slug":"stack-traces-sentry-apollo-graphql"}},"staticQueryHashes":["3649515864","983108779"],"slicesMap":{}}