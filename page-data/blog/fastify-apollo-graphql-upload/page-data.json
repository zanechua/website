{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/fastify-apollo-graphql-upload/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://zanechua.com"}},"posts":{"html":"<p>Working with new frameworks and relatively \"obscure\" ones always have the trouble of needing to figure out everything yourself.</p>\n<p>Recently I had to implement uploads via GraphQL on ApolloServer 3 with Fastify 3. There was no documentation on how to do so that was specific to Fastify, only the typical express way of implementing the <code class=\"language-text\">graphql-upload</code> package. Thus began the journey on finding out how to do it.</p>\n<h1 id=\"Journey\" style=\"position:relative;\">Journey<a href=\"#Journey\" aria-label=\"Journey permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Initially I was wrapping my head wrongly around how content parsers work in Fastify and I thought that I needed a plugin so I installed <code class=\"language-text\">fastify-multipart</code> to handle it. Turns out I was wrong about that and if you do install the multi-part plugin, you'll have to uninstall it.</p>\n<p>You can only have 1 content parser per <code class=\"language-text\">Content-Type</code>, by registering the plugin you won't be able configure a content-type parser to process the request into the format that <code class=\"language-text\">graphql-upload</code> needs.</p>\n<h1 id=\"Solve\" style=\"position:relative;\">Solve<a href=\"#Solve\" aria-label=\"Solve permalink\" class=\"remark-header-anchor after\"><svg id=\"header-anchor-icon\" aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>I found a solution on how to implement <code class=\"language-text\">graphql-upload</code> but it turns out someone already beat me to it and with a more elegant method. You can see the original on GitHub <a href=\"https://github.com/apollographql/apollo-server/issues/4975\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n<p>One caveat about the solution below is that I don't need to handle multi-part requests via a REST API at the moment so it doesn't bother me, but I might get around to it one day and I will write about it again if I do.</p>\n<p>Just add the following snippet of code to your fastify project and you should be good.</p>\n<div\n              class=\"gatsby-code-button-container\"\n              data-toaster-id=\"6488734803878860000\"\n              data-toaster-class=\"gatsby-code-button-toaster\"\n              data-toaster-text-class=\"gatsby-code-button-toaster-text\"\n              data-toaster-text=\"Copied\"\n              data-toaster-duration=\"3000\"\n              onClick=\"copyToClipboard(`import { processRequest } from 'graphql-upload';\n\nfastify.addContentTypeParser('multipart', (req, done) => {\n  req.isMultipart = true;\n  done();\n});\n\nfastify.addHook('preValidation', async function (request, reply) {\n  if (!request.isMultipart) {\n    return;\n  }\n\n  request.body = await processRequest(request.raw, reply.raw, {\n    maxFileSize: 10000000, // 10 MB\n    maxFiles: 20\n  });\n});`, `6488734803878860000`)\"\n            >\n              <div\n                class=\"gatsby-code-button\"\n                data-tooltip=\"\"\n              >\n                Copy<svg class=\"gatsby-code-button-icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><path fill=\"none\" d=\"M0 0h24v24H0V0z\"/><path d=\"M16 1H2v16h2V3h12V1zm-1 4l6 6v12H6V5h9zm-1 7h5.5L14 6.5V12z\"/></svg>\n              </div>\n            </div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> processRequest <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-upload'</span><span class=\"token punctuation\">;</span>\n\nfastify<span class=\"token punctuation\">.</span><span class=\"token function\">addContentTypeParser</span><span class=\"token punctuation\">(</span><span class=\"token string\">'multipart'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> done</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  req<span class=\"token punctuation\">.</span>isMultipart <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfastify<span class=\"token punctuation\">.</span><span class=\"token function\">addHook</span><span class=\"token punctuation\">(</span><span class=\"token string\">'preValidation'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> reply</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request<span class=\"token punctuation\">.</span>isMultipart<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  request<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">processRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>raw<span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">.</span>raw<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">maxFileSize</span><span class=\"token operator\">:</span> <span class=\"token number\">10000000</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 10 MB</span>\n    <span class=\"token literal-property property\">maxFiles</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>If you need to view a full example, you can find one in this <a href=\"https://github.com/apollographql/apollo-server/issues/4975\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pull request</a> and it'll be available in the file upload section of <a href=\"https://www.apollographql.com/docs/apollo-server/data/file-uploads/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">apollo docs</a> when it's merged.</p>","excerpt":"Working with new frameworks and relatively \"obscure\" ones always have the trouble of needing to figure out everything yourself. Recently I had to implement uploads via GraphQL on ApolloServer 3 with Fastify 3. There was no documentation on how to doâ€¦","timeToRead":1,"frontmatter":{"date":"09 August, 2021","updatedAt":null,"slug":"fastify-apollo-graphql-upload","title":"Fastify with Apollo Server and GraphQL Upload","tags":["graphql","node","fastify","apollo server","file upload"],"featuredImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAA5klEQVQY02N4aroaK3phugaETEAIlxoGTKFnpqsfma26ZrXsmtXSa9bLr9ssf2S+6pkJEZqfmK1+Y7R2XtDkhPz6nNzWsqopufUTl0TNeW245okZQZvNVj/XX7Ukf97ei6cPHTt26/6D2x9er6tZ+1R3xVPzNYQ0m695qrtyffGyc9cvLdx0dOuJu6++ftjdsOWJznJiNa8oXXL5ydUZ+65tuPn5+/8fW5o2EaX5idnql4ZrNoXNWzRp5Yq+tTsW7N+6fP/OuGUvDVYT4WdIgBuvvqe/7J7+srv6S+/qL3tmtAprVAEAxDQiTpbs8XoAAAAASUVORK5CYII="},"backgroundColor":"transparent","images":{"fallback":{"src":"/static/dc764c66dfefa5f69d53b2f3e55aea36/6fc77/fastify-apollo-graphql-upload.png","srcSet":"/static/dc764c66dfefa5f69d53b2f3e55aea36/85ced/fastify-apollo-graphql-upload.png 800w,\n/static/dc764c66dfefa5f69d53b2f3e55aea36/7c498/fastify-apollo-graphql-upload.png 1080w,\n/static/dc764c66dfefa5f69d53b2f3e55aea36/6fc77/fastify-apollo-graphql-upload.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/dc764c66dfefa5f69d53b2f3e55aea36/28281/fastify-apollo-graphql-upload.webp 800w,\n/static/dc764c66dfefa5f69d53b2f3e55aea36/0b5d5/fastify-apollo-graphql-upload.webp 1080w,\n/static/dc764c66dfefa5f69d53b2f3e55aea36/a020d/fastify-apollo-graphql-upload.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":500}}}}},"comments":{"edges":[]}},"pageContext":{"slug":"fastify-apollo-graphql-upload"}},"staticQueryHashes":["3649515864","983108779"],"slicesMap":{}}